<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <title>Google Analytics (<%= settings.frequency.capitalize %>)</title>

  <style type="text/css">
    body {
      background: #fff;
      color: #000;
      width: 384px;
      padding: 0;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .chart {
      width: 360px;
      height: 180px;
    }
    .line {
      fill: none;
      stroke: #000;
      stroke-width: 3px;
    }

    /* OLD: */
    .line-1 {
      stroke: #000;
    }
    .chart .axis-y .tick line {
        stroke: #ddd;
    }
    .chart .axis-x path {
      /* The baseline. */
      stroke: #000;
      shape-rendering: crispEdges;
    }
    .chart .axis-x .tick line {
      /* The individual ticks. */
      stroke: #000;
    }

  </style>

  <%# Include the d3 JS so that it renders inline. The BERG Cloud renderer seems to have problems when JS files are included as scripts. %>
  <%= erb(:js_d3, :layout => false) %>

  <script>
    window.onload = function() {

      function draw_chart(chart_number, data) {
        // Size of whole chart, including axes and space around it:
        var outer_width = 384;
        var outer_height = 180;
        var margin = {top: 0, right: 10, bottom: 30, left: 10};
        // Size of the area of the chart with the actual lines on:
        var inner_width = outer_width - margin.left - margin.right;
        var inner_height = outer_height - margin.top - margin.bottom;

        // Turn a date/time string into a Date object.
        var parseDate = d3.time.format('%H%M').parse;

        // How we want the X-Axis dates/times formatted.
        var x_tick_format = d3.time.format('%H');

        // The scales.
        var x = d3.time.scale().range([0, inner_width]);

        var y = d3.scale.linear().range([inner_height, 0]);

        var color = d3.scale.ordinal();

        var xAxis = d3.svg.axis().scale(x).orient('bottom')
                      .tickFormat(function(d) { return x_tick_format(d); });

        var yAxis = d3.svg.axis().scale(y).orient('left');

        var line = d3.svg.line()
                    .interpolate('basis')
                    .x(function(d) { return x(d.date); })
                    .y(function(d) { return y(d.visits ); });

        var svg = d3.select('#chart-'+chart_number).append('svg')
            .attr('width', outer_width)
            .attr('height', outer_height)
          .append('g')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        d3plot(data);

        function d3plot(data) {
          color.domain(d3.keys(data[0]).filter(
                                  function(key) { return key !== 'date'; }));

          data.forEach(function(d) {
            d.date = parseDate(d.date);
          });

          var periods = color.domain().map(function(name) {
            return {
              name: name,
              values: data.map(function(d) {
                return {date: d.date, visits: +d[name]};
              })
            };
          });

          x.domain(d3.extent(data, function(d) { return d.date; }));

          y.domain([
            0,
            d3.max(periods, function(c) {
              return d3.max(c.values, function(v) {return v.visits; }); })
          ]);

          svg.append('g')
              .attr('class', 'x axis')
              .attr('transform', 'translate(0,' + inner_height + ')')
              .call(xAxis);

          var period = svg.selectAll('.period')
              .data(periods)
            .enter().append('g')
              .attr('class', 'period');
            

          var line_colors = {
            'period0': '#000000',
            'period1': '#999999'
          };
          period.append('path')
              .attr('class', 'line')
              .attr('d', function(d) { return line(d.values); })
              .style('stroke', function(d) { return line_colors[d.name]; });
        };
      };

      <% @profiles_data.each_with_index do |p, profile_idx| %>
        var data = [];

        <% p[:periods][0][:visits].each_with_index do |v, visit_idx| %>
          data.push({
            'period0': <%= v.visits %>,
            'period1': <%= p[:periods][1][:visits].to_a[visit_idx].visits %>,
            'date': '<%= v.hour %>00'
          });
        <% end %>

        draw_chart(<%= profile_idx %>, data);

      <% end %>
    };

  </script>

</head>
<body>
  <h1>Google Analytics (<%= settings.frequency.capitalize %>)</h1>

  <% @profiles_data.each_with_index do |p, idx| %>
    <h2><%= p[:name] %></h2>

    <% if p[:periods][0][:start_date] == p[:periods][0][:end_date] %>
      <p>For <%= p[:periods][0][:start_date] %>.</p>
    <% else %>
      <p>From <%= p[:periods][0][:start_date] %> to <%= p[:periods][0][:end_date] %>.</p>
    <% end %>

    <h3>Visits</h3>

    <div id="chart-<%= idx %>" class="chart"></div>

<% 
=begin %>
    <h4><% if settings.frequency == 'weekly' %>Last week<% else %>Yesterday<% end %></h4>
    <ul>
      <% p[:periods][0][:visits].each do |v| %>
        <li><%= v.date %><% if settings.frequency == 'daily' %> <%= v.hour %>:00<% end %> – <%= v.visits %></li>
      <% end %> 
    </ul>

    <h4>Previous</h4>
    <ul>
      <% p[:periods][1][:visits].each do |v| %>
        <li><%= v.date %><% if settings.frequency == 'daily' %> <%= v.hour %>:00<% end %> – <%= v.visits %></li>
      <% end %> 
    </ul>
<% 
=end %>

    <h3>Totals</h2>
    <p>Visits: 
      <% if p[:periods][0][:total_visits] > p[:periods][1][:total_visits] %>
      ^
      <% elsif p[:periods][0][:total_visits] < p[:periods][1][:total_visits] %>
      v
      <% else %>
      –
      <% end %>
      <%= p[:periods][0][:total_visits] %> (<%= p[:periods][1][:total_visits] %>)</p>
    <p>Visitors: 
      <% if p[:periods][0][:total_visitors] > p[:periods][1][:total_visitors] %>
      ^
      <% elsif p[:periods][0][:total_visitors] < p[:periods][1][:total_visitors] %>
      v
      <% else %>
      –
      <% end %>
      <%= p[:periods][0][:total_visitors] %> (<%= p[:periods][1][:total_visitors] %>)</p>
    <p>Pageviews:
      <% if p[:periods][0][:total_pageviews] > p[:periods][1][:total_pageviews] %>
      ^
      <% elsif p[:periods][0][:total_pageviews] < p[:periods][1][:total_pageviews] %>
      v
      <% else %>
      –
      <% end %>
      <%= p[:periods][0][:total_pageviews] %> (<%= p[:periods][1][:total_pageviews] %>)</p>
  <% end %>



</body>
</html>
